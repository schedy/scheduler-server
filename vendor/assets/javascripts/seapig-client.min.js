(function(){var t,e,n,o,i=function(t,e){function n(){this.constructor=t}for(var o in e)s.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},s={}.hasOwnProperty;this.SeapigClient=function(){function e(t,e){null==e&&(e={}),this.uri=t,this.options=e,this.slave_objects={},this.master_objects={},this.connected=!1,this.socket=void 0,this.error=void 0,this.connect()}return e.prototype.connect=function(){var t,e;null!=this.socket&&this.disconnect(),this.reconnect_on_close=!0;try{this.socket=new WebSocket(this.uri)}catch(e){return t=e,this.error={"while":"connecting",error:t},null!=this.onstatuschange_proc&&this.onstatuschange_proc(this),!1}return this.socket.onopen=function(t){return function(){var e,n,o,i,s,r,c;t.options.debug&&console.log("Connected to seapig server"),t.connected=!0,t.error=null,null!=t.onstatuschange_proc&&t.onstatuschange_proc(t),t.socket.send(JSON.stringify({action:"client-options-set",options:t.options})),s=t.slave_objects;for(o in s)i=s[o],t.socket.send(JSON.stringify({action:"object-consumer-register",pattern:o,"version-known":i.version})),i.validate();r=t.master_objects,c=[];for(o in r)i=r[o],t.socket.send(JSON.stringify({action:"object-producer-register",pattern:o,"version-known":i.version})),o.indexOf("*")>=0?c.push(function(){var t,o;t=i.children,o=[];for(n in t)e=t[n],o.push(e.upload(0,{},e.version,!0));return o}()):c.push(void 0);return c}}(this),this.socket.onclose=this.socket_onclose=function(t){return function(){var e,n,o;t.options.debug&&console.log("Seapig connection closed"),t.connected=!1,t.socket=void 0,o=t.slave_objects;for(e in o)n=o[e],n.invalidate();return null!=t.onstatuschange_proc&&t.onstatuschange_proc(t),null!=t.reconnection_timer&&clearTimeout(t.reconnection_timer),t.reconnection_timer=null,t.reconnect_on_close?t.reconnection_timer=setTimeout(function(){return t.reconnection_timer=void 0,t.connect()},2e3):void 0}}(this),this.socket.onerror=function(t){return function(e){return t.options.debug&&console.log("Seapig socket error",e),t.error={"while":"connected",error:e}}}(this),this.socket.onmessage=function(t){return function(e){var n,o,i,s,r,c,h;switch(i=JSON.parse(e.data),i.action){case"object-update":r=t.slave_objects;for(o in r)s=r[o],s.matches(i.id)&&s.patch(i);break;case"object-destroy":c=t.slave_objects;for(o in c)s=c[o],s.matches(i.id)&&s.destroy(i.id);h=t.master_objects;for(o in h)s=h[o],s.matches(i.id)&&s.destroy(i.id);break;case"object-produce":n=_.find(_.values(t.master_objects),function(t){return t.matches(i.id)}),!n&&t.options.debug&&console.error('Seapig server submitted invalid "produce" request',i),n&&n.produce(i.id,i["version-inferred"]);break;default:t.options.debug&&console.error("Seapig server submitted an unsupported message",i)}return null}}(this)},e.prototype.disconnect=function(){return this.reconnect_on_close=!1,null!=this.reconnection_timer&&(clearTimeout(this.reconnection_timer),this.reconnection_timer=null),null!=this.socket?(this.socket.onclose=null,this.socket.close(),this.socket_onclose()):void 0},e.prototype.onstatuschange=function(t){return this.onstatuschange_proc=t,this},e.prototype.slave=function(t,e){if(null==e&&(e={}),e.object&&!e.version||!e.object&&e.version)throw"Both or none of 'object' and 'version' are needed";return this.slave_objects[t]=t.indexOf("*")>=0?new o(this,t,e):new n(this,t,e),this.connected&&this.socket.send(JSON.stringify({action:"object-consumer-register",pattern:t,"version-known":this.slave_objects[t].version})),this.slave_objects[t]},e.prototype.master=function(e,n){return null==n&&(n={}),this.master_objects[e]=e.indexOf("*")>=0?new SeapigWildcardMasterObject(this,e,n):new t(this,e,n),this.connected&&this.socket.send(JSON.stringify({action:"object-producer-register",pattern:e,"version-known":this.master_objects[e].version})),this.master_objects[e]},e.prototype.unlink=function(t){return null!=this.slave_objects[t]&&(delete this.slave_objects[t],this.connected&&this.socket.send(JSON.stringify({action:"object-consumer-unregister",pattern:t}))),null!=this.master_objects[t]&&(delete this.master_objects[t],this.connected)?this.socket.send(JSON.stringify({action:"object-producer-unregister",pattern:t})):void 0},e}(),e=function(){function t(t,e,n){this.client=t,this.id=e,this.destroyed=!1,this.object={},this.ondestroy_proc=void 0,this.onstatuschange_proc=void 0,this.initialized=!!n.object,null!=n.object&&_.extend(this.object,n.object)}return t.prototype.destroy=function(t){return this.destroyed=!0,null!=this.onstatuschange_proc&&this.onstatuschange_proc(this),null!=this.ondestroy_proc?this.ondestroy_proc(this):void 0},t.prototype.matches=function(t){return t.match(new RegExp(this.id.replace(/[^A-Za-z0-9*]/g,"\\$&").replace("*",".*?")))},t.prototype.sanitized=function(){return JSON.parse(JSON.stringify(this.object))},t.prototype.ondestroy=function(t){return this.ondestroy_proc=t,this},t.prototype.onstatuschange=function(t){return this.onstatuschange_proc=t,this},t.prototype.unlink=function(){return this.client.unlink(this.id)},t}(),n=function(t){function e(t,n,o){e.__super__.constructor.call(this,t,n,o),this.version=o.version||0,this.valid=!1,this.received_at=null}return i(e,t),e.prototype.onchange=function(t){return this.onchange_proc=t,this},e.prototype.patch=function(t){var e,n,o,i,s;if(this.received_at=new Date,n=JSON.stringify(this.object),t["version-old"]&&0!==t["version-old"]&&null==t.value)_.isEqual(this.version,t["version-old"])||console.error("Seapig lost some updates, this shouldn't ever happen. object:",this.id," version:",this.version," message:",t);else{o=this.object;for(e in o)s=o[e],delete this.object[e]}if(null!=t.value){i=t.value;for(e in i)s=i[e],this.object[e]=s}else jsonpatch.apply(this.object,t.patch);return this.version=t["version-new"],this.valid=!0,this.initialized=!0,null!=this.onstatuschange_proc&&this.onstatuschange_proc(this),null!=this.onchange_proc&&n!==JSON.stringify(this.object)?this.onchange_proc(this):void 0},e.prototype.validate=function(){return this.valid=this.initialized,null!=this.onstatuschange_proc?this.onstatuschange_proc(this):void 0},e.prototype.invalidate=function(){return this.valid=!1,null!=this.onstatuschange_proc?this.onstatuschange_proc(this):void 0},e}(e),t=function(t){function e(t,n,o){e.__super__.constructor.call(this,t,n,o),this.version=o.version||[(new Date).getTime(),0],this.shadow=this.sanitized(),this.stall=!1}return i(e,t),e.prototype.onproduce=function(t){return this.onproduce_proc=t,this},e.prototype.set=function(t){var e,n,o;if(null==t&&(t={}),null!=t.version&&(this.version=t.version),null!=t.object){this.stall=!1,n=this.object;for(e in n)o=n[e],delete this.object[e];_.extend(this.object,t.object)}else(t.object===!1||t.stall)&&(this.stall=!0);return this.shadow=this.sanitized(),this.initialized=!0,this.upload(0,{},this.version,this.stall?!1:this.shadow)},e.prototype.bump=function(t){var e,n;return null==t&&(t={}),n=this.version,e=this.shadow,this.version=t.version||[n[0],n[1]+1],this.shadow=this.sanitized(),this.initialized=!0,this.upload(n,e,this.version,this.stall?!1:this.shadow)},e.prototype.produce=function(t,e){if(null!=this.onproduce_proc)return this.onproduce_proc(this,e);if(!this.initialized)throw"Master object "+t+" has to either be initialized at all times or have an onproduce callback";return this.upload(0,{},this.version,this.shadow)},e.prototype.upload=function(t,e,n,o){var i;return this.client.connected&&(0===t||o===!1||o===!0?this.client.socket.send(JSON.stringify({id:this.id,action:"object-patch","version-new":n,value:o})):(i=jsonpatch.compare(e,o),JSON.stringify(i).length<JSON.stringify(o).length?this.client.socket.send(JSON.stringify({id:this.id,action:"object-patch","version-old":t,"version-new":n,patch:i})):this.client.socket.send(JSON.stringify({id:this.id,action:"object-patch","version-new":n,value:o})))),this},e}(e),o=function(t){function e(t,n,o){e.__super__.constructor.call(this,t,n,o),this.children={}}return i(e,t),e.prototype.patch=function(t){return null==this.children[t.id]&&(this.children[t.id]=new n(this.client,t.id,{}).onchange(this.onchange_proc).onstatuschange(this.onstatuschange_proc).ondestroy(this.ondestroy_proc),this.object[t.id]=this.children[t.id].object),this.children[t.id].patch(t)},e.prototype.destroy=function(t){var e;if(null!=(e=this.children[t]))return delete this.object[t],delete this.children[t],e.destroy(t)},e}(n)}).call(this);
//# sourceMappingURL=seapig-client.min.js.map
